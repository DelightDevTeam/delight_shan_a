// to remove laravel log
php -r "file_put_contents('/var/www/html/delight_shan_a/storage/logs/laravel.log', '');"
// created dev branch for kzt

tail -f /var/www/html/delight_shan_a/storage/logs/laravel.log

crontab -e

* * * * * cd /var/www/html/delight_shan_a && php artisan schedule:run >> /dev/null 2>&1


php artisan make:migration add_agent_link_to_users_table --table=users

sudo chown -R www-data:www-data /var/www/html/delight_shan_a/bootstrap/cache
sudo chmod -R 775 /var/www/html/delight_shan_a/bootstrap/cache

## GameLogin 
MD5 (FunctionName + RequestDateTime + OperatorId + SecretKey + PlayerId)
## GetBalance 
MD5 (FunctionName + RequestDateTime + OperatorId + SecretKey + PlayerId)
## Bet
MD5 (FunctionName + BetId + RequestDateTime + OperatorId + SecretKey + PlayerId)
## GameResult
MD5 (FunctionName + ResultId + RequestDateTime + OperatorId + SecretKey + PlayerId)
## RollBack
MD5 (FunctionName + BetId + RequestDateTime + OperatorId + SecretKey + PlayerId)
## CashBonu 
 (FunctionName + TranId + RequestDateTime + OperatorId + SecretKey + PlayerId)


 <?php

namespace App\Http\Controllers\Api\Live22;

use App\Enums\StatusCode;
use App\Http\Controllers\Controller;
use App\Http\Requests\SlotWebhookRequest;
use App\Services\GameService;
use App\Services\SlotWebhookService;
use App\Services\SlotWebhookValidator;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class GetBalanceController extends Controller
{
    public function getBalance(SlotWebhookRequest $request)
    {
        Log::info('GetBalance request initiated', ['request_data' => $request->all()]);

        DB::beginTransaction();
        try {
            // Validate the request using the SlotWebhookValidator
            Log::info('Starting validation process');
            $validator = SlotWebhookValidator::make($request)->validate();

            Log::info('Validation passed, preparing balance response');
            $balance = $request->getMember()->wallet->balance;
            $response = SlotWebhookService::buildResponse(StatusCode::OK, $balance, $balance);

            Log::info('Returning response', ['response' => $response]);

            return response()->json($response);

            DB::commit();

            // Build and return the success response
            Log::info('Returning successful response');

            return SlotWebhookService::buildResponse(
                StatusCode::OK,
                $balance,
                $balance
            );
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('An error occurred during GetBalance', [
                'exception' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            // Handle any unexpected exceptions and return an error message
            return response()->json([
                'message' => $e->getMessage(),
            ], 500);
        }
    }
}

